---
title: 笔记：MySQL技术内幕-04
date: 2020-04-15
categories: 
  - 笔记
tags: 
  - 数据库
---

<html>
<head>
  <title></title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/604762 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5825"/>

<div>
<span><div><div><div><hr/><div><span style="font-weight: bold;">索引组织表</span></div><div>按主键</div><div><br/></div><hr/><div><span style="font-weight: bold;">逻辑存储结构</span></div><div>=&gt; 所有数据都被逻辑地放置在表空间内，又分别由以下组成 segment, extent, page, row</div><div><br/></div><div><br/></div><div><img src="/assets/images/innodb_inside_04/Image.png" type="image/png" data-filename="Image.png" width="687"/></div><div><br/></div><div>1.每张表的独立表空间存放：数据、索引、插入缓冲Bitmap页</div><div>   共享表空间内存放：回滚信息、插入缓冲索引页、系统事务信息、二次写缓冲等</div><div><span style="font-size: unset; color: unset; font-family: unset;">   共享表空间还是会不断增大</span></div><div><br/></div><div>2.数据段：B+树的叶子节点</div><div>   索引段：B+树的非叶子节点</div><div><br/></div><div>3.区大小 1MB，内部有64个页，每个页是16k</div><div>   即使引入压缩页，但区的大小始终是1M，同时页的大小也是可以自定义的</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql&gt; show variables like 'innodb_page%'\g;</div><div>+------------------+-------+</div><div>| Variable_name    | Value |</div><div>+------------------+-------+</div><div>| innodb_page_size | 16384 |</div><div>+------------------+-------+</div></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">实际情况是：每个段开始时，现有32个碎片页来存放数据，使用完后才会申请64个连续页</span></div><div>可以使用py_innodb_page_info.py工具查看idb文件的页分配；</div><div><br/></div><div>4.行记录格式  Row_format:Compat</div><div><img src="/assets/images/innodb_inside_04/Image-1.png" type="image/png" data-filename="Image.png" width="892"/></div><div><br/></div><div><img src="/assets/images/innodb_inside_04/Image-2.png" type="image/png" data-filename="Image.png" width="535"/></div><div><br/></div><div>变长字段长度列表：各列的长度，每列用1-2字节表示</div><div>NULL标记位：用位来标记各列是否有NULL</div><div>记录头信息：5字节长度，记录了是否删除、下一记录指针等</div><div>列数据：</div><div><br/></div></div><div>5.行溢出数据</div><div>    所有VARCHAR列的长度总和不能超过65535字节的数据，否则要求使用text或blob</div><div>    但超过时，部分数据放在B-tree Node的子节点上，另外的数据作为溢出数据放在blob页中</div><div>    <img src="/assets/images/innodb_inside_04/Image-3.png" type="image/png" data-filename="Image.png"/></div><div>    ? 放多少数据在B+Node上，多少在Blob页上呢？</div><div>    =&gt;原则是，因为按索引组织即B+结构，需确保每个页16k上至少有2条记录，否则索引结构失去意义，即8098字节</div><div><br/></div><div>    对于TEXT和Blob的数据类型，是放在数据页还是Blob页，需看是否一个页能否存放2条记录</div><div>    =&gt;实际数据页只保存数据的前768字节</div><div><br/></div><div>6.新的行记录格式 </div><div><img src="/assets/images/innodb_inside_04/Image-4.png" type="image/png" data-filename="Image.png"/></div><div>新增2种新的行记录格式：Compressed, Dynamic</div><div>5.6默认使用格式 Compact</div><div>5.7默认使用格式 Dynamic</div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">=&gt; 新格式对于存放在Blob中的数据采用了完全的行溢出方式，在数据页中只存放20个字节的指针，实际数据都放在Blob页中</span></div><div><br/></div><div><br/></div><hr/><div><span style="font-weight: bold;">Innodb数据页格式</span></div><div>1.数据页格式</div><div><img src="/assets/images/innodb_inside_04/Image-5.png" type="image/png" data-filename="Image.png"/></div><div>1.File Header：头信息，如页类型，表空间中也的偏移，上一个/下一个页的指针</div><div>2.Page Header：状态信息，如记录数，插入记录的位置，在索引数中的level层</div><div>3.Infimum/Supremum：记录的主键值的上下边界</div><div>4.User Record：实际存储数据</div><div>5.Free Space：空间空间</div><div>6.Page Directory：记录的相对位置，将所有记录的主键按顺序存放，便于二叉查找记录</div><div>7.File Trailer：尾信息，用于保证页的完整性</div><div><br/></div><div><span style="font-weight: bold; background-color: rgb(255, 250, 165);-evernote-highlight:true;">要点：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>1.B+树索引用来快速找到记录所在的页，不能找到具体的一条记录；</div><div>2.页载入内存后，通过Page Directory的有序主键做二叉查找，找到具体的记录；</div></div><div><br/></div><div>2.解决页兼容问题 Named File Formats机制</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>//5.6中</div><div>mysql&gt; show variables like '%file_format'\g;</div><div>+--------------------+----------+</div><div>| Variable_name      | Value    |</div><div>+--------------------+----------+</div><div>| innodb_file_format | Antelope |</div><div>+--------------------+----------+</div><div><br/></div><div>//5.7中</div><div>mysql root@[localhost:mysql3306.sock carddb_20001] &gt; show variables like '%file_format%'\g;</div><div>+--------------------------+-----------+</div><div>| Variable_name            | Value     |</div><div>+--------------------------+-----------+</div><div>| innodb_file_format       | Barracuda |</div><div>| innodb_file_format_check | ON        |</div><div>| innodb_file_format_max   | Barracuda |</div><div>+--------------------------+-----------+</div></div><div><br/></div><div><br/></div></div><hr/><div><span style="font-weight: bold;">约束和索引</span></div><div>1.索引是一个数据结构，既有逻辑上的概念，用于B+树代表物理存储方式</div><div>   约束是逻辑的概念，用于保证数据的完整性</div><div>   </div><div>    索引类型有：主键索引，唯一索引，全文索引</div><div>    约束类型有：主键约束、唯一约束、外键约束、默认值</div><div><br/></div><div>2.查找约束，表 information_schema.table_constraints</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql root@[localhost:mysql3306.sock (none)] &gt; <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">select * from information_schema.table_constraints;</span></div><div>+--------------------+-------------------+------------------+--------------+---------------------------+-----------------+</div><div>| CONSTRAINT_CATALOG | CONSTRAINT_SCHEMA | CONSTRAINT_NAME  | TABLE_SCHEMA | TABLE_NAME                | CONSTRAINT_TYPE |</div><div>+--------------------+-------------------+------------------+--------------+---------------------------+-----------------+</div><div>| def                | carddb_10000      | PRIMARY          | carddb_10000 | t_account                 | PRIMARY KEY     |</div><div>| def                | carddb_11000      | Index_SRedeem_ID | carddb_11000 | t_sredeem                 | UNIQUE          |</div></div><div><br/></div><div>3.对输入值做合法性约束检查        STRICT_TRANS_TABLES</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql root@[localhost:mysql3306.sock (none)] &gt; show variables like '%sql_mode%'\g;</div><div>+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+</div><div>| Variable_name | Value                                                                                                                                     |</div><div>+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+</div><div>| sql_mode      | ONLY_FULL_GROUP_BY,<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">STRICT_TRANS_TABLES</span>,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</div><div>+---------------+-------------------------------------------------------------------------------------------------------------------------------------------+</div></div><div><br/></div><div>4.Enum约束，目前只能实现枚举离散约束，不能实现完整的check约束</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>sex ENUM('male', 'femaile')</div></div><div><br/></div><div>5.创建触发器trigger</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>create trigger 触发器名 BEFORE/AFTER UPDATE/DELETE/INSERT on 表名 for each row</div><div>begin</div><div>if new.cache &gt; old.cache then</div><div>xxxx</div><div>endif;</div><div>end;</div><div>$$</div></div><div><br/></div><div>6.创建外键，即时检查</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">foreign key (列名) references 表名(列名) </span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">on delete 选项</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">on update 选项</span></div></div><div>可供选择的选项有：</div><div>set null             字表数据设置为null</div><div>no action          抛出错误，不允许</div><div>restrict              抛出错误，不允许（默认）</div><div>cascade            更新，也执行update/delete操作</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">show variables like 'foreign_key_checks'\g;</span></div><div>|foreign_key_checks | ON    |</div></div><div><br/></div><div>6.实现完整性约束的手段：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>主键/唯一键：</div><div>Enum约束：离散数值</div><div>创建触发器：保证操作完整性</div><div><font face="Monaco">外键约束：保证参照完整性</font></div></div><div><br/></div><hr/><div><span style="font-weight: bold;">视图</span></div><div>1.命名的虚表，没有实际的物理存储</div><div>   视图也可用于隔离基本表，起到一个安全层的作用</div><div>2.也可以对视图执行更新操作，应用到基本表上</div><div>3.MYSQL不支持物化视图，只能通过触发器实现类似视图功能；</div><div><br/></div><div><br/></div><hr/><div><span style="font-weight: bold;">分区表</span></div><div>1.MYSQL支持水平分区，不支持垂直分区</div><div>   同时，只能是局部分区索引（一个分区中既有数据也有索引）， 还不支持全局分区</div><div>2.<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">分区主要用于数据库高可用性的管理</span></div><div>3.支持以下几种类型的分区：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>1.RANGE分区：按列值所属连续区间来分区</div><div>2.LIST分区：离散的值来分区</div><div>3.HASH分区：自定义的表达式的返回值来分区  =&gt; 均匀分布到各分区中</div><div>4.KEY分区：数据库提供的函数来分区</div><div>5.COLUMNS分区：可使用非整数来分区</div></div><div><br/></div><div>3.使用 EXPLAIN PARTITIONS命令查看</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql root@[localhost:mysql3306.sock carddb_11000] &gt; <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">explain partitions</span> select * from t_account limit 10\G;</div><div>*************************** 1. row ***************************</div><div>           id: 1</div><div>  select_type: SIMPLE</div><div>        table: t_account</div><div>   <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">partitions</span>: NULL</div></div><div><span style="font-size: unset; color: unset; font-family: unset;">=&gt;分区修剪可提升查询效率</span></div><div><br/></div><div>4.分区和性能</div><div>OLAP应用中，分区可以很好地提升查询的性能</div><div>OLTP应用中，走主键分区的索引并不会带来性能提升，反而会引起更大开销</div><div><br/></div><div>非主键查询，数据库会搜索所有的分区，导致更多的IO，影响查询的性能</div><div><br/></div></div></span>
</div></body></html> 
